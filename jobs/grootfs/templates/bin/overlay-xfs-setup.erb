#!/bin/bash

set -x
set -e

BASE_PATH=$(dirname $0)

main() {
  source /var/vcap/jobs/grootfs/bin/utils

  export PATH=/var/vcap/packages/grootfs/bin:/var/vcap/packages/xfs-progs/sbin:$PATH
  local privileged_store_path=/var/vcap/data/grootfs/store/privileged
  local privileged_volume_file=/var/vcap/data/grootfs/volume_privileged
  local privileged_config=/var/vcap/jobs/grootfs/config/privileged_grootfs_config.yml
  local unprivileged_store_path=/var/vcap/data/grootfs/store/unprivileged
  local unprivileged_volume_file=/var/vcap/data/grootfs/volume_unprivileged
  local unprivileged_config=/var/vcap/jobs/grootfs/config/grootfs_config.yml

  create_loop_devices
  permit_device_control

  create_store $privileged_store_path $privileged_volume_file $privileged_config
  create_store $unprivileged_store_path $unprivileged_volume_file $unprivileged_config

  chmod 0700 $privileged_store_path
  setup_unprivileged_store $unprivileged_store_path

  tardis_setup
}

create_store() {
  local store_path=$1
  local volume_file=$2
  local config_path=$3

  echo "Creating ${store_path} store"

  mkdir -p "$store_path"

  create_volume_file $volume_file

  log_device=$(losetup -f)
  format_volume_file $volume_file $log_device

  mount_xfs_volume $volume_file $store_path $log_device
}


format_volume_file() {
  local volume_file=$1
  local log_device=$2
  local log_volume_file=${volume_file}_log

  losetup -d $(losetup -a | grep $log_volume_file | cut -d ":" -f1)
  <% if p("grootfs.use_external_logdevice") %>
  echo "formatting log volume..."
  dd if=/dev/zero of=$log_volume_file bs=1M count=<%= p("grootfs.external_logdevice_size_in_mb") %>
  losetup $log_device $log_volume_file
  <% end %>

  if [ -z "$(file $volume_file | grep -i "XFS filesystem")" ]
  then
    echo "formatting volume..."
    mkfs.xfs -f $volume_file
  fi
}

mount_xfs_volume() {
  local volume_file=$1
  local store_path=$2
  local log_device=$3

  echo "mounting volume..."
  <% mount_options = ["pquota"] + Array(p("grootfs.extra_mount_options")) %>
  mount -t xfs -o remount,<%= mount_options.join(",") %> $volume_file $store_path || mount -t xfs -o <%= mount_options.join(",") %> $volume_file $store_path
}

tardis_setup() {
  echo "setting up tardis..."
  chmod u+s /var/vcap/packages/grootfs/bin/tardis
}

main
