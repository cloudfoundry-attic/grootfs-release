#!/bin/bash

set -x

BASE_PATH=$(dirname $0)

main() {
  source /var/vcap/jobs/grootfs/bin/utils

  export PATH=/var/vcap/packages/grootfs/bin:/var/vcap/packages/xfs-progs/sbin:$PATH
  local privileged_store_path=/var/vcap/data/grootfs/store/privileged
  local privileged_volume_file=/var/vcap/data/grootfs/volume_privileged
  local privileged_config=/var/vcap/jobs/grootfs/config/privileged_grootfs_config.yml
  local unprivileged_store_path=/var/vcap/data/grootfs/store/unprivileged
  local unprivileged_volume_file=/var/vcap/data/grootfs/volume_unprivileged
  local unprivileged_config=/var/vcap/jobs/grootfs/config/grootfs_config.yml

  delete_store $privileged_config $privileged_store_path $privileged_volume_file
  delete_store $unprivileged_config $unprivileged_store_path $unprivileged_volume_file

  create_loop_devices
  permit_device_control

  mkdir -p "$privileged_store_path"
  mkdir -p "$unprivileged_store_path"

  create_volume_file $privileged_volume_file
  create_volume_file $unprivileged_volume_file

  privileged_log_device=$(losetup -f)
  format_volume_file $privileged_volume_file $privileged_log_device
  unprivileged_log_device=$(losetup -f)
  format_volume_file $unprivileged_volume_file $unprivileged_log_device

  mount_xfs_volume $privileged_volume_file $privileged_store_path $privileged_log_device
  mount_xfs_volume $unprivileged_volume_file $unprivileged_store_path $unprivileged_log_device

  chmod 0700 $privileged_store_path
  setup_unprivileged_store $unprivileged_store_path

  tardis_setup
}

format_volume_file() {
  local volume_file=$1
  local log_device=$2
  local log_volume_file=${volume_file}_log

  echo "formatting log volume..."
  losetup -d $(losetup -a | grep $log_volume_file | cut -d ":" -f1)
  dd if=/dev/zero of=$log_volume_file bs=1M count=64
  losetup $log_device $log_volume_file

  echo "formatting volume..."
  mkfs.xfs -f -l size=64m,logdev=$log_device $volume_file
}

mount_xfs_volume() {
  local volume_file=$1
  local store_path=$2
  local log_device=$3

  echo "mounting volume..."
  umount $store_path || true
  mount -t xfs -o pquota,noatime,nobarrier,logdev=$log_device $volume_file $store_path
}

tardis_setup() {
  echo "setting up tardis..."
  chmod u+s /var/vcap/packages/grootfs/bin/tardis
}

main
