#!/bin/bash
RUN_PATH=/var/vcap/sys/run/dstate-counter
PID_FILE=${RUN_PATH}/dstate-counter.pid

echo $$ > $PID_FILE

while true
do
  currenttime=$(date +%s)
  count=$(ps axho state | grep 'D' | wc -l)

  /var/vcap/packages/metatron/bin/metatron --metron-endpoint="127.0.0.1:<%= p('grootfs.dropsonde_port') %>" \
    --prefix="grootfs" \
    --name="dstate-processes" \
    --value=$count

  echo "DState counter: $count"
  sleep <%= p('dstate_counter.interval') %>
done
