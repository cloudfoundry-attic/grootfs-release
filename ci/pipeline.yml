---
groups:
- name: all
  jobs:
  - grootfs
  - deliver
  - bump-dependencies
  - bump-grootfs-release
  - create-grootfs-release
  - deploy-grootfs-bench
  - btrfs-performance-tests
  - xfs-performance-tests
  - grootfs-bench
  - bump-grootfs-bench-release
  - create-grootfs-bench-release
  - deploy-grootfs-bench
  - deploy-garden-grootfs
  - GATs
  - deploy-cf
  - CATs
  - gamora-vizzini
  - deploy-thanos-cf
  - bench-with-loops
  - bench-without-loops
  - thanos-vizzini-shed
  - thanos-vizzini-grootfs
  - thanos-vizzini-grootfs-custom-agent
  - thanos-refresh-rootfs
  - deploy-stable-release
  - test-upgrade
  - test-grootfs-diagnostics-release
  - create-grootfs-diagnostics-release
- name: grootfs
  jobs:
  - grootfs
  - bump-dependencies
  - bump-grootfs-release
  - create-grootfs-release
  - deploy-grootfs-bench
  - btrfs-performance-tests
  - xfs-performance-tests
  - deliver
- name: diagnostics
  jobs:
  - test-grootfs-diagnostics-release
  - create-grootfs-diagnostics-release
- name: bench-release
  jobs:
  - grootfs-bench
  - bump-grootfs-bench-release
  - create-grootfs-bench-release
  - deploy-grootfs-bench
- name: upgrade
  jobs:
  - deploy-stable-release
  - test-upgrade
  - deliver
- name: garden
  jobs:
  - deploy-garden-grootfs
  - GATs
  - deliver
- name: gamora-cf
  jobs:
  - deploy-cf
  - CATs
  - gamora-vizzini
  - deliver
- name: thanos-cf
  jobs:
  - deploy-thanos-cf
  - thanos-vizzini-shed
  - thanos-vizzini-grootfs
  - thanos-vizzini-grootfs-custom-agent
  - thanos-refresh-rootfs
  - bench-with-loops
  - bench-without-loops
- name: tools
  jobs:
  - build-grootfs-ci-image
- name: ship-it
  jobs:
  - bump-major-grootfs-release
  - bump-minor-grootfs-release
  - bump-patch-grootfs-release
  - merge-master-into-develop
  - ship-bosh-release
  - ship-grootfs
  - tag-grootfs-ci-image

resources:
- name: cats-concourse-task
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cats-concourse-task.git

- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-acceptance-tests.git

- name: monday-update
  type: time
  source:
    start: 7:00 AM
    stop: 8:00 AM
    location: Europe/London
    days:
    - Monday

- name: grootfs-release-latest
  type: bosh-io-release
  source:
    repository: cloudfoundry/grootfs-release

- name: garden-runc-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/garden-runc-release
    branch: master
    ignore_paths:
    - ci

- name: diego-release-git
  type: git
  source:
    uri: https://github.com/cloudfoundry/diego-release
    branch: master

- name: diegocanaryapp
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/diegocanaryapp.git

- name: git-cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment
    branch: master

- name: cf-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: cf

- name: thanos-cf-deployment
  type: bosh-deployment-resource
  source:
    target: {{thanos-bosh-target}}
    client: {{thanos-bosh-username}}
    client_secret: {{thanos-bosh-password}}
    ca_cert: {{thanos-root-ca-cert}}
    deployment: cf

- name: garden-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release

- name: diego-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/diego-release

- name: cflinuxfs2-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cflinuxfs2-release

- name: datadog-nozzle-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/datadog-firehose-nozzle-release

- name: grootfs-git-repo
  type: git
  source:
    uri: {{grootfs-git-repo}}
    branch: master
    private_key: {{gnome-private-key}}

- name: grootfs-release-develop
  type: git
  source:
    uri: {{grootfs-release-git-repo}}
    branch: develop
    private_key: {{gnome-private-key}}

- name: grootfs-release-master
  type: git
  source:
    uri: {{grootfs-release-git-repo}}
    branch: master
    private_key: {{gnome-private-key}}

- name: grootfs-diagnostics-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/grootfs-diagnostics-release
    branch: develop
    private_key: {{gnome-private-key}}

- name: grootfs-diagnostics-release-version
  type: semver
  source:
    bucket: grootfs-ci-meta
    key: grootfs-diagnostics-release-version
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: eu-west-1
    initial_version: 0.1.1-rc.1
    driver: s3

- name: grootfs-diagnostics-release-tarball
  type: s3
  source:
    bucket: grootfs-bosh-releases
    regexp: grootfs-diagnostics-releases/grootfs-diagnostics-(.*).tgz
    region_name: eu-west-1
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}

- name: grootfs-release-version
  type: semver
  source:
    bucket: grootfs-ci-meta
    key: {{s3-version-key}}
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: eu-west-1
    initial_version: 0.1.0-rc.1
    driver: s3

- name: grootfs-ci-secrets
  type: git
  source:
    uri: git@github.com:cloudfoundry/grootfs-ci-secrets.git
    branch: master
    private_key: {{gnome-private-key}}

- name: grootfs-release-tarball
  type: s3
  source:
    bucket: grootfs-bosh-releases
    regexp: {{s3-release-tarball-regexp}}
    region_name: eu-west-1
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}

- name: grootfs-bench-release-tarball
  type: s3
  source:
    bucket: grootfs-bench-releases
    regexp: releases/grootfs-bench-(.*).tgz
    region_name: eu-west-1
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}

- name: grootfs-bench-git-repo
  type: git
  source:
    uri: git@github.com:cloudfoundry/grootfs-bench.git
    branch: master
    private_key: {{gnome-private-key}}
    ignore_paths:
    - ci/grootfs-bench-tests.yml

- name: grootfs-bench-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/grootfs-bench-release.git
    branch: master
    private_key: {{gnome-private-key}}

- name: grootfs-bench-release-version
  type: semver
  source:
    bucket: grootfs-ci-meta
    key: grootfs/bosh-bench-release-version
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: eu-west-1
    initial_version: 0.1.0-rc.1
    driver: s3

- name: performance-time-trigger
  type: time
  source:
    interval: 60m

- name: thanos-bench-time-trigger
  type: time
  source:
    interval: 10m

- name: vizzini-time-trigger
  type: time
  source:
    interval: 15m

- name: vizzini-rootfs-refresher
  type: time
  source:
    interval: 2h

- name: grootfs-bench-btrfs-remote-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: grootfs-bench-btrfs-remote

- name: grootfs-bench-btrfs-local-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: grootfs-bench-btrfs-local

- name: grootfs-bench-xfs-local-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: grootfs-bench-xfs-local

- name: grootfs-bench-xfs-remote-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: grootfs-bench-xfs-remote

- name: garden-grootfs-deployment
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: garden-grootfs

- name: garden-grootfs-deployment-rolling-upgrade
  type: bosh-deployment-resource
  source:
    target: {{gamora-bosh-target}}
    client: {{gamora-bosh-username}}
    client_secret: {{gamora-bosh-password}}
    ca_cert: {{gamora-root-ca-cert}}
    deployment: garden-grootfs-rolling-upgrade

- name: gamora-bosh-stemcell
  type: bosh-io-stemcell
  source:
    name: {{gamora-bosh-stemcell-name}}

- name: thanos-bosh-stemcell
  type: bosh-io-stemcell
  source:
    name: {{thanos-bosh-stemcell-name}}

- name: slack-alert
  type: slack-notification-docker
  source:
    url: {{slack-alert-url}}

- name: grootfs-tracker
  type: tracker-fixed
  source:
    tracker_url: https://www.pivotaltracker.com
    project_id: "1661239"
    token: {{garden-tracker-token}}

- name: grootfs-standalone-gh-release
  type: github-release
  source:
    user: {{github-organization}}
    repository: grootfs
    access_token: {{github-access-token}}
    drafts: true

- name: grootfs-gh-release
  type: github-release
  source:
    user: {{github-organization}}
    repository: grootfs-release
    access_token: {{github-access-token}}
    drafts: true

- name: grootfs-git-repo-dockerfile
  type: git
  source:
    uri: {{grootfs-git-repo}}
    branch: master
    private_key: {{gnome-private-key}}
    paths:
    - Dockerfile

- name: grootfs-ci-image
  type: docker-image
  source:
    repository: cfgarden/grootfs-ci
    username: {{dockerhub-username}}
    password: {{dockerhub-password}}

- name: datadog-event
  type: datadog-event
  source:
    api_key: {{datadog-api-key}}
    application_key: {{datadog-application-key}}

jobs:
- name: grootfs
  public: true
  plan:
  - aggregate:
    - get: grootfs-git-repo
      trigger: true
  - do:
    - task: make
      privileged: true
      file: grootfs-git-repo/ci/tasks/make.yml
    - aggregate:
      - task: unit-tests
        privileged: true
        file: grootfs-git-repo/ci/tasks/unit-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
      - task: integration-tests-OVERLAY+XFS (ROOT)
        privileged: true
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          GROOTFS_TEST_UID: 0
          GROOTFS_TEST_GID: 0
          VOLUME_DRIVER: overlay-xfs
      - task: integration-tests-OVERLAY+XFS (GROOT)
        privileged: true
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          GROOTFS_TEST_UID: 1000
          GROOTFS_TEST_GID: 1000
          VOLUME_DRIVER: overlay-xfs
      - task: integration-tests-BTRFS (ROOT)
        privileged: true
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          VOLUME_DRIVER: btrfs
          GROOTFS_TEST_UID: 0
          GROOTFS_TEST_GID: 0
      - task: integration-tests-BTRFS (GROOT)
        privileged: true
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          GROOTFS_TEST_UID: 1000
          GROOTFS_TEST_GID: 1000
          VOLUME_DRIVER: btrfs
      - task: go-vet
        file: grootfs-git-repo/ci/tasks/go-vet.yml
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: System Failure. Explosion Imminent. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: bump-dependencies
  public: true
  plan:
  - get: monday-update
    trigger: true
  - get: grootfs-git-repo
    params:
      submodules: all
  - task: bump-dependencies
    file: grootfs-git-repo/ci/tasks/bump-dependencies.yml
  - do:
    - aggregate:
      - task: unit-tests
        privileged: true
        input_mapping:
          grootfs-git-repo: grootfs-git-repo-updated
        file: grootfs-git-repo/ci/tasks/unit-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
      - task: integration-tests-OVERLAY+XFS
        privileged: true
        input_mapping:
          grootfs-git-repo: grootfs-git-repo-updated
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          VOLUME_DRIVER: overlay-xfs
      - task: integration-tests-BTRFS
        privileged: true
        input_mapping:
          grootfs-git-repo: grootfs-git-repo-updated
        file: grootfs-git-repo/ci/tasks/integration-tests.yml
        params:
          REGISTRY_USERNAME: {{dockerhub-username}}
          REGISTRY_PASSWORD: {{dockerhub-password}}
          VOLUME_DRIVER: btrfs
      - task: go-vet
        file: grootfs-git-repo/ci/tasks/go-vet.yml
        input_mapping:
          grootfs-git-repo: grootfs-git-repo-updated
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: Bump dependencies failed. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"
  - put: grootfs-git-repo
    params:
      repository: grootfs-git-repo-updated

- name: bump-grootfs-release
  serial_groups: [grootfs-release-creation]
  plan:
    - do:
      - aggregate:
        - get: grootfs-release-develop
        - get: grootfs-git-repo
          trigger: true
          passed:
          - grootfs
          params:
            submodules: none
      - task: bump-grootfs-release
        file: grootfs-release-develop/ci/tasks/bump-grootfs-release.yml
      - put: grootfs-release-develop
        params:
          repository: bumped-release-git
      on_failure:
        put: slack-alert
        params:
          username: {{slack-alert-username}}
          icon_url: {{slack-alert-icon-url}}
          channel: {{slack-alert-channel}}
          text: "<!subteam^S1U0HSJ9E|grootfsteam>: What the BOSH? You can bump it yourself. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: create-grootfs-release
  serial_groups: [grootfs-release-creation]
  plan:
  - aggregate:
    - get: version
      resource: grootfs-release-version
      params:
        pre: rc
    - get: release
      resource: grootfs-release-develop
      trigger: true
    - get: grootfs-release-develop
      params:
        submodules: none
    - get: grootfs-git-repo
      passed:
      - bump-grootfs-release
      params:
        submodules: none
  - put: grootfs-release-version
    params:
      file: version/number
  - do:
    - task: create-grootfs-release
      file: grootfs-release-develop/ci/tasks/create-bosh-release.yml
      params:
        NAME: grootfs
    - put: grootfs-release-tarball
      params:
        file: bosh-release/grootfs-*.tgz
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: What the BOSH? You can deploy it yourself. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: deploy-stable-release
  serial_groups: [grootfs-garden-rolling-upgrade-deployment]
  plan:
  - do:
    - aggregate:
      - get: gamora-bosh-stemcell
      - get: grootfs-ci-secrets
      - get: grootfs-release-develop
        params:
          submodules: none
      - get: garden-release
        trigger: true
      - get: grootfs-release-latest
        trigger: true
      - get: grootfs-release-tarball
        trigger: true
        passed:
        - create-grootfs-release
      - get: garden-runc-release
    - task: delete-garden-grootfs-rolling-upgrade-deployment
      file: grootfs-release-develop/ci/tasks/delete-deployment.yml
      params:
        BOSH_ENVIRONMENT: {{gamora-bosh-target}}
        BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
        BOSH_CLIENT: {{gamora-bosh-username}}
        BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
        BOSH_DEPLOYMENT: garden-grootfs-rolling-upgrade
    - put: garden-grootfs-deployment-rolling-upgrade
      params:
        manifest: grootfs-ci-secrets/deployments/garden-grootfs/gcp-rolling-upgrade.yml
        releases:
        - garden-release/*.tgz
        - grootfs-release-latest/*.tgz
        stemcells:
        - gamora-bosh-stemcell/*.tgz
    - aggregate:
      - task: gats-btrfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: 10.0.1.18
      - task: gats-overlay-xfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: 10.0.1.19
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: System Failure. Explosion Imminent. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: test-upgrade
  serial_groups: [grootfs-garden-rolling-upgrade-deployment]
  plan:
  - do:
    - aggregate:
      - get: gamora-bosh-stemcell
      - get: grootfs-ci-secrets
      - get: grootfs-release-develop
        params:
          submodules: none
      - get: garden-release
        trigger: true
      - get: grootfs-release-tarball
        trigger: true
        passed:
        - deploy-stable-release
      - get: garden-runc-release
        passed:
        - deploy-stable-release
    - put: garden-grootfs-deployment-rolling-upgrade
      params:
        manifest: grootfs-ci-secrets/deployments/garden-grootfs/gcp-rolling-upgrade.yml
        releases:
        - garden-release/*.tgz
        - grootfs-release-tarball/*.tgz
        stemcells:
        - gamora-bosh-stemcell/*.tgz
    - aggregate:
      - task: gats-btrfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: 10.0.1.18
      - task: gats-overlay-xfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: 10.0.1.19
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: System Failure. Explosion Imminent. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: deploy-garden-grootfs
  serial_groups: [grootfs-garden-deployment]
  plan:
  - do:
    - aggregate:
      - get: gamora-bosh-stemcell
      - get: grootfs-ci-secrets
      - get: grootfs-release-develop
        params:
          submodules: none
      - get: garden-release
        trigger: true
      - get: grootfs-release-tarball
        trigger: true
        passed:
        - create-grootfs-release
    - put: garden-grootfs-deployment
      params:
        manifest: grootfs-ci-secrets/deployments/garden-grootfs/gcp.yml
        releases:
        - garden-release/*.tgz
        - grootfs-release-tarball/*.tgz
        stemcells:
        - gamora-bosh-stemcell/*.tgz
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: System Failure. Explosion Imminent. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: GATs
  serial_groups: [grootfs-garden-deployment]
  plan:
    - aggregate:
      - get: grootfs-release-develop
        trigger: true
        passed: [deploy-garden-grootfs]
        params:
          submodules: none
      - get: garden-release
        passed: [deploy-garden-grootfs]
        trigger: true
      - get: garden-runc-release
    - aggregate:
      - task: gats-btrfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: {{gamora-btrfs-garden-address}}
      - task: gats-overlay-xfs
        file: grootfs-release-develop/ci/tasks/gats.yml
        params:
          GARDEN_ADDRESS: {{gamora-overlay-xfs-garden-address}}

- name: bump-grootfs-bench-release
  serial: true
  plan:
    - aggregate:
      - get: grootfs-bench-release
      - get: grootfs-bench-git-repo
        trigger: true
        passed:
        - grootfs-bench
    - do:
      - task: bump-grootfs-bench-release
        file: grootfs-bench-release/ci/tasks/bump-grootfs-bench-release.yml
      - put: grootfs-bench-release
        params:
          repository: bumped-release-git
      on_failure:
        put: slack-alert
        params:
          username: {{slack-alert-username}}
          icon_url: {{slack-alert-icon-url}}
          channel: {{slack-alert-channel}}
          text: "<!subteam^S1U0HSJ9E|grootfsteam>: It's not the end of the world, it's just the end of this pipeline. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: create-grootfs-bench-release
  serial: true
  plan:
    - aggregate:
      - get: grootfs-bench-release
        trigger: true
      - get: grootfs-bench-git-repo
        passed:
        - bump-grootfs-bench-release
      - get: grootfs-bench-release-version
        params:
          pre: rc
    - do:
      - put: grootfs-bench-release-version
        params:
          file: grootfs-bench-release-version/number
      - task: create-release
        file: grootfs-bench-release/ci/tasks/create-grootfs-bench-release.yml
      - put: grootfs-bench-release-tarball
        params:
          file: bosh-release/grootfs-bench-*.tgz
      on_failure:
        put: slack-alert
        params:
          username: {{slack-alert-username}}
          icon_url: {{slack-alert-icon-url}}
          channel: {{slack-alert-channel}}
          text: "<!subteam^S1U0HSJ9E|grootfsteam>: You know what, fix it. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: deploy-grootfs-bench
  serial_groups:
  - deploy-bench-btrfs
  - deploy-bench-xfs
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
        trigger: true
        passed:
        - create-grootfs-release
        params:
          submodules: none
      - get: grootfs-release-tarball
        trigger: true
        passed:
        - create-grootfs-release
      - get: grootfs-bench-release
        passed:
        - create-grootfs-bench-release
      - get: grootfs-bench-release-tarball
        trigger: true
        passed:
        - create-grootfs-bench-release
      - get: gamora-bosh-stemcell
        trigger: true
      - get: grootfs-ci-secrets
    - aggregate:
      - put: grootfs-bench-btrfs-local-deployment
        params:
          manifest: grootfs-ci-secrets/deployments/grootfs-bench/grootfs-bench-btrfs-local.yml
          releases:
          - grootfs-release-tarball/*.tgz
          - grootfs-bench-release-tarball/*.tgz
          stemcells:
          - gamora-bosh-stemcell/*.tgz
          vars:
            datadog_api_key: {{datadog-api-key}}
            datadog_app_key: {{datadog-application-key}}
      - put: grootfs-bench-btrfs-remote-deployment
        params:
          manifest: grootfs-ci-secrets/deployments/grootfs-bench/grootfs-bench-btrfs-remote.yml
          releases:
          - grootfs-release-tarball/*.tgz
          - grootfs-bench-release-tarball/*.tgz
          stemcells:
          - gamora-bosh-stemcell/*.tgz
          vars:
            datadog_api_key: {{datadog-api-key}}
            datadog_app_key: {{datadog-application-key}}
      - put: grootfs-bench-xfs-local-deployment
        params:
          manifest: grootfs-ci-secrets/deployments/grootfs-bench/grootfs-bench-xfs-local.yml
          releases:
          - grootfs-release-tarball/*.tgz
          - grootfs-bench-release-tarball/*.tgz
          stemcells:
          - gamora-bosh-stemcell/*.tgz
          vars:
            datadog_api_key: {{datadog-api-key}}
            datadog_app_key: {{datadog-application-key}}
      - put: grootfs-bench-xfs-remote-deployment
        params:
          manifest: grootfs-ci-secrets/deployments/grootfs-bench/grootfs-bench-xfs-remote.yml
          releases:
          - grootfs-release-tarball/*.tgz
          - grootfs-bench-release-tarball/*.tgz
          stemcells:
          - gamora-bosh-stemcell/*.tgz
          vars:
            datadog_api_key: {{datadog-api-key}}
            datadog_app_key: {{datadog-application-key}}
      - task: publish-commit-event-to-datadog
        privileged: true
        file: grootfs-bench-release/ci/tasks/publish-commit-event.yml
        params:
          ERRAND_NAME: grootfs-bench-local-btrfs
          DATADOG_API_KEY: {{datadog-api-key}}
          DATADOG_APPLICATION_KEY: {{datadog-application-key}}
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: What the BOSH? You can deploy it yourself. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: btrfs-performance-tests
  serial_groups:
  - deploy-bench-btrfs
  plan:
  public: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
        trigger: true
        passed:
        - deploy-grootfs-bench
        params:
          submodules: none
      - get: grootfs-bench-release
        trigger: true
        passed:
        - deploy-grootfs-bench
      - get: performance-time-trigger
        trigger: true
    - aggregate:
      - task: benchmark-LOCAL-BTRFS
        privileged: true
        file: grootfs-bench-release/ci/tasks/performance-tests.yml
        params:
          BOSH_TARGET: {{gamora-bosh-target}}
          BOSH_CLIENT: {{gamora-bosh-username}}
          BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
          BOSH_DEPLOYMENT: grootfs-bench-btrfs-local
          BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
          ERRAND_NAME: grootfs-bench-local-btrfs
          DATADOG_API_KEY: {{datadog-api-key}}
          DATADOG_APPLICATION_KEY: {{datadog-application-key}}
      - task: benchmark-REMOTE-BTRFS
        privileged: true
        file: grootfs-bench-release/ci/tasks/performance-tests.yml
        params:
          BOSH_TARGET: {{gamora-bosh-target}}
          BOSH_CLIENT: {{gamora-bosh-username}}
          BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
          BOSH_DEPLOYMENT: grootfs-bench-btrfs-remote
          BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
          ERRAND_NAME: grootfs-bench-remote-btrfs
          DATADOG_API_KEY: {{datadog-api-key}}
          DATADOG_APPLICATION_KEY: {{datadog-application-key}}
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: You don't need metrics for a thing that doesn't even work! http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: xfs-performance-tests
  serial_groups:
  - deploy-bench-xfs
  plan:
  public: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
        trigger: true
        passed:
        - deploy-grootfs-bench
        params:
          submodules: none
      - get: grootfs-bench-release
        trigger: true
        passed:
        - deploy-grootfs-bench
      - get: performance-time-trigger
        trigger: true
    - aggregate:
      - task: benchmark-LOCAL-OVERLAY-XFS
        privileged: true
        file: grootfs-bench-release/ci/tasks/performance-tests.yml
        params:
          BOSH_TARGET: {{gamora-bosh-target}}
          BOSH_CLIENT: {{gamora-bosh-username}}
          BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
          BOSH_DEPLOYMENT: grootfs-bench-xfs-local
          BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
          ERRAND_NAME: grootfs-bench-local-overlay-xfs
          DATADOG_API_KEY: {{datadog-api-key}}
          DATADOG_APPLICATION_KEY: {{datadog-application-key}}
      - task: benchmark-REMOTE-OVERLAY-XFS
        privileged: true
        file: grootfs-bench-release/ci/tasks/performance-tests.yml
        params:
          BOSH_TARGET: {{gamora-bosh-target}}
          BOSH_CLIENT: {{gamora-bosh-username}}
          BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
          BOSH_DEPLOYMENT: grootfs-bench-xfs-remote
          BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
          ERRAND_NAME: grootfs-bench-remote-overlay-xfs
          DATADOG_API_KEY: {{datadog-api-key}}
          DATADOG_APPLICATION_KEY: {{datadog-application-key}}
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: You don't need metrics for a thing that doesn't even work! http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: bump-patch-grootfs-release
  serial: true
  plan:
  - get: grootfs-git-repo
  - get: grootfs-release-version
    params: { bump: patch, pre: rc }
    passed: [ship-bosh-release]
    trigger: true
  - put: grootfs-release-version
    resource: grootfs-release-version
    params: { file: grootfs-release-version/number }
  - get: grootfs-next-final-version
    resource: grootfs-release-version
    params: { bump: patch }
  - task: bump-binary-version
    file: grootfs-git-repo/ci/tasks/bump-version.yml
  - put: grootfs-git-repo
    params:
      repository: bumped-grootfs-repo

- name: bump-major-grootfs-release
  serial: true
  plan:
  - get: grootfs-release-version
    params: { bump: major, pre: rc }
  - put: grootfs-release-version
    resource: grootfs-release-version
    params: { file: grootfs-release-version/number }
  - get: grootfs-git-repo
  - get: grootfs-next-final-version
    resource: grootfs-release-version
    params: { bump: major }
  - task: bump-binary-version
    file: grootfs-git-repo/ci/tasks/bump-version.yml
  - put: grootfs-git-repo
    params:
      repository: bumped-grootfs-repo

- name: bump-minor-grootfs-release
  serial: true
  plan:
  - get: grootfs-release-version
    params: { bump: minor, pre: rc }
  - put: grootfs-release-version
    resource: grootfs-release-version
    params: { file: grootfs-release-version/number }
  - get: grootfs-git-repo
  - get: grootfs-next-final-version
    resource: grootfs-release-version
    params: { bump: minor }
  - task: bump-binary-version
    file: grootfs-git-repo/ci/tasks/bump-version.yml
  - put: grootfs-git-repo
    params:
      repository: bumped-grootfs-repo

- name: ship-bosh-release
  serial: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-ci-secrets
      - get: dev-release
        resource: grootfs-release-develop
        passed: [deploy-grootfs-bench]
      - get: grootfs-release-develop
        passed: [deploy-grootfs-bench]
      - get: version
        resource: grootfs-release-version
        params:
          bump: final
    - task: check-version
      file: grootfs-release-develop/src/code.cloudfoundry.org/grootfs/ci/tasks/check-version.yml
    - task: ship-it
      file: grootfs-release-develop/ci/tasks/ship-it.yml
      params:
        PRIVATE_YML: {{grootfs-release-private-yaml}}
        NAME: grootfs
    - aggregate:
      - put: grootfs-release-master
        params:
          repository: release/master
          tag: version/number
          tag_prefix: v
      - put: grootfs-release-tarball
        params:
          file: final-release/grootfs-*.tgz
      - put: grootfs-gh-release
        params:
          name: version/number
          tag: version/number
          tag_prefix: v
          globs:
          - final-release/grootfs-*.tgz
      - put: grootfs-release-version
        params: { file: version/number }
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: Final bosh release went super wrong. Sorry. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: ship-grootfs
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-master
        passed: [ship-bosh-release]
      - get: grootfs-release-version
        trigger: true
        passed: [ship-bosh-release]
    - task: build-grootfs
      file: grootfs-release-master/src/code.cloudfoundry.org/grootfs/ci/tasks/build-grootfs.yml
    - put: grootfs-git-repo
      params:
        tag: grootfs-release-version/number
        tag_prefix: v
        repository: grootfs-release-master/src/code.cloudfoundry.org/grootfs
        only_tag: true
    - put: grootfs-standalone-gh-release
      params:
        name: grootfs-release-version/number
        tag: grootfs-release-version/number
        tag_prefix: v
        globs:
        - build-grootfs/grootfs-*
        - build-grootfs/drax-*
        - build-grootfs/tardis-*
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: I don't know how to create github release anyway!  http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: tag-grootfs-ci-image
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-master
        passed: [ship-bosh-release]
      - get: grootfs-release-version
        trigger: true
        passed: [ship-bosh-release]
    - put: grootfs-ci-image
      params:
        build: grootfs-release-master/src/code.cloudfoundry.org/grootfs
        tag_prefix: v
        tag: grootfs-release-version/number
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: I don't know how to create github release anyway!  http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"


- name: merge-master-into-develop
  serial: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
      - get: grootfs-release-master
        passed:
        - ship-bosh-release
        trigger: true
    - task: merge-master-into-develop
      file: grootfs-release-develop/ci/tasks/merge-master-into-develop.yml
    - put: grootfs-release-develop
      params:
        repository: release-merged
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: I CAN'T BUMP DEVELOP. http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: grootfs-bench
  public: true
  plan:
  - aggregate:
    - get: grootfs-bench-git-repo
      trigger: true
  - task: grootfs-bench-tests
    file: grootfs-bench-git-repo/ci/grootfs-bench-tests.yml
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: {{slack-alert-icon-url}}
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: I've destroyed your build (groot tests are dead). Come and get me!  http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: build-grootfs-ci-image
  plan:
  - aggregate:
    - get: grootfs-git-repo-dockerfile
      trigger: true
      params:
        submodules: none
  - put: grootfs-ci-image
    params:
      build: grootfs-git-repo-dockerfile

- name: deploy-cf
  serial_groups: [deploy-cf]
  plan:
  - aggregate:
    - get: grootfs-release-tarball
    - get: git-cf-deployment
      trigger: true
    - get: grootfs-release-develop
      passed: [create-grootfs-release]
      trigger: true
      params:
        submodules: none
    - get: grootfs-ci-secrets
    - get: gamora-bosh-stemcell
    - get: garden-release
      trigger: true
    - get: cflinuxfs2-release
      trigger: true
    - get: diego-release
      trigger: true
    - get: diego-release-git
      params:
        submodules: none
    - get: datadog-nozzle-release
      trigger: true
  - task: generate-cf-manifest
    file: grootfs-release-develop/ci/tasks/generate-cf-manifest.yml
    params:
      CF_SYSTEM_DOMAIN: grootfs-gamora.cf-app.com
      CF_PASSWORD: {{gamora-cf-password}}
      CF_SECRETS: {{cf-secrets}}
      CF_UAA_CERTS: {{cf-uaa-certs}}
      CF_ETCD_CERTS: {{cf-etcd-certs}}
      CF_CC_CERTS: {{cf-cc-certs}}
      CF_CONSUL_CERTS: {{cf-consul-certs}}
      CF_DIEGO_CERTS: {{cf-diego-certs}}
      CF_LOGGREGATOR_CERTS: {{cf-loggregator-certs}}
      CF_NETWORKING: {{cf-networking}}
      DATADOG_API_KEY: {{datadog-api-key}}
      DATADOG_METRIC_PREFIX: "datadog.gamora.nozzle."
      IAAS: gcp
  - put: cf-deployment
    params:
      manifest: manifests/cf.yml
      releases:
      - diego-release/*.tgz
      - cflinuxfs2-release/*.tgz
      - grootfs-release-tarball/*.tgz
      - garden-release/*.tgz
      - datadog-nozzle-release/*.tgz
      stemcells:
      - gamora-bosh-stemcell/*.tgz
  - task: enable-docker-feature-flag
    file: grootfs-release-develop/ci/tasks/enable-docker-feature-flag.yml
    params:
      CF_USERNAME: {{gamora-cf-username}}
      CF_PASSWORD: {{gamora-cf-password}}

- name: CATs
  serial_groups:
  - deploy-cf
  plan:
  - aggregate:
    - get: cf-acceptance-tests
    - get: cats-concourse-task
    - get: grootfs-release-develop
      trigger: true
      passed: [deploy-cf]
  - task: generate-cats-config-json
    file: grootfs-release-develop/ci/tasks/generate-cats-config-json.yml
    params:
      CF_PASSWORD: {{gamora-cf-password}}
      CF_API: grootfs-gamora.cf-app.com
  - task: run-cats
    file: cats-concourse-task/task.yml

- name: gamora-vizzini
  serial_groups:
  - deploy-cf
  plan:
  - aggregate:
    - get: vizzini-time-trigger
      trigger: true
    - get: grootfs-release-develop
      trigger: true
      passed: [deploy-cf]
      params:
        submodules: none
  - task: run-vizzini
    privileged: true
    file: grootfs-release-develop/ci/tasks/vizzini.yml
    params:
      BOSH_TARGET: {{gamora-bosh-target}}
      BOSH_CLIENT: {{gamora-bosh-username}}
      BOSH_CLIENT_SECRET: {{gamora-bosh-password}}
      BOSH_CERTIFICATES: {{gamora-bosh-certificates}}
      BOSH_DEPLOYMENT: cf
      ERRAND_NAME: vizzini
    on_failure:
      task: publish-datadog-event
      file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
      params:
        DATADOG_API_KEY: {{datadog-api-key}}
        EVENT_NAME: "vizzini-failed-gamora"
        TAG: gamora

- name: deploy-thanos-cf
  serial_groups: [deploy-thanos-cf]
  plan:
  - aggregate:
    - get: grootfs-diagnostics-release-tarball
      trigger: true
    - get: grootfs-release-tarball
      tags: [thanos]
    - get: git-cf-deployment
      tags: [thanos]
      trigger: true
    - get: grootfs-release-develop
      tags: [thanos]
      trigger: true
      params:
        submodules: none
    - get: grootfs-diagnostics-develop
      tags: [thanos]
      params:
        submodules: none
    - get: grootfs-ci-secrets
      tags: [thanos]
    - get: thanos-bosh-stemcell
      tags: [thanos]
    - get: garden-release
      tags: [thanos]
      trigger: true
    - get: cflinuxfs2-release
      tags: [thanos]
    - get: diego-release
      tags: [thanos]
      trigger: true
    - get: diego-release-git
      tags: [thanos]
      params:
        submodules: none
    - get: diegocanaryapp
      tags: [thanos]
    - get: datadog-nozzle-release
      tags: [thanos]
  - task: generate-cf-manifest
    tags: [thanos]
    file: grootfs-release-develop/ci/tasks/generate-thanos-cf-manifest.yml
    params:
      CF_SYSTEM_DOMAIN: grootfs-thanos.cf-app.com
      CF_PASSWORD: {{thanos-cf-password}}
      CF_SECRETS: {{thanos-cf-secrets}}
      CF_UAA_CERTS: {{thanos-cf-uaa-certs}}
      CF_ETCD_CERTS: {{thanos-cf-etcd-certs}}
      CF_CC_CERTS: {{thanos-cf-cc-certs}}
      CF_CONSUL_CERTS: {{thanos-cf-consul-certs}}
      CF_DIEGO_CERTS: {{thanos-cf-diego-certs}}
      CF_LOGGREGATOR_CERTS: {{thanos-cf-loggregator-certs}}
      CF_NETWORKING: {{thanos-cf-networking}}
      DATADOG_API_KEY: {{datadog-api-key}}
      DATADOG_APPLICATION_KEY: {{datadog-application-key}}
      DATADOG_METRIC_PREFIX: "datadog.thanos.nozzle."
  - put: thanos-cf-deployment
    tags: [thanos]
    params:
      manifest: manifests/cf.yml
      releases:
      - diego-release/*.tgz
      - cflinuxfs2-release/*.tgz
      - grootfs-release-tarball/*.tgz
      - grootfs-diagnostics-release-tarball/*.tgz
      - garden-release/*.tgz
      - datadog-nozzle-release/*.tgz
      stemcells:
      - thanos-bosh-stemcell/*.tgz
  - task: enable-docker-feature-flag
    tags: [thanos]
    file: grootfs-release-develop/ci/tasks/enable-docker-feature-flag.yml
    params:
      CF_API_URL: api.grootfs-thanos.cf-app.com
      CF_USERNAME: {{thanos-cf-username}}
      CF_PASSWORD: {{thanos-cf-password}}
  - task: isolate-canaries
    tags: [thanos]
    file: grootfs-release-develop/ci/tasks/isolate-canaries.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      CF_API_URL: api.grootfs-thanos.cf-app.com
      CF_USERNAME: {{thanos-cf-username}}
      CF_PASSWORD: {{thanos-cf-password}}

- name: thanos-refresh-rootfs
  serial_groups: [vizzini]
  plan:
  - get: vizzini-rootfs-refresher
    tags: [thanos]
    trigger: true
  - get: grootfs-release-develop
    params:
      submodules: none
  - task: force-unpack-cflinuxfs2-loop
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/force-unpack.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      CELL_NAME: diego-cell
      CLEAN: true
  - task: force-unpack-cflinuxfs2-loopless
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/force-unpack.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      CELL_NAME: diego-cell-custom-agent
      CLEAN: true
  - task: force-unpack-cflinuxfs2-shed
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/force-unpack.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      CELL_NAME: diego-cell-shed
      CLEAN: false
  - put: datadog-event
    params:
      title: thanos-rootfs-refresh
      text: The rootfs was refreshed

- name: thanos-vizzini-grootfs
  serial_groups: [vizzini]
  plan:
  - aggregate:
    - get: vizzini-time-trigger
      tags: [thanos]
      trigger: true
    - get: diego-release-git
    - get: grootfs-release-develop
      tags: [thanos]
      trigger: true
      params:
        submodules: none
  - task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-starting-standard-groot"
      TAG: grootfs
  - task: run-vizzini-grootfs
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/vizzini-ginkgo.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      DIEGO_CREDENTIALS: {{thanos-cf-diego-certs}}
      ENV: thanos
      PLACEMENT_TAG: grootfs
    on_failure:
      task: publish-datadog-event
      file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
      params:
        DATADOG_API_KEY: {{datadog-api-key}}
        EVENT_NAME: vizzini-failed-standard-groot
        TAG: grootfs
  ensure:
    task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-ending-standard-groot"
      TAG: grootfs

- name: thanos-vizzini-shed
  serial_groups: [vizzini]
  plan:
  - aggregate:
    - get: vizzini-time-trigger
      tags: [thanos]
      trigger: true
    - get: diego-release-git
    - get: grootfs-release-develop
      tags: [thanos]
      trigger: true
      params:
        submodules: none
  - task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-starting-shed"
      TAG: shed
  - task: run-vizzini-shed
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/vizzini-ginkgo.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      DIEGO_CREDENTIALS: {{thanos-cf-diego-certs}}
      ENV: thanos
      PLACEMENT_TAG: shed
    on_failure:
      task: publish-datadog-event
      file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
      params:
        DATADOG_API_KEY: {{datadog-api-key}}
        EVENT_NAME: vizzini-failed-shed
        TAG: shed
  ensure:
    task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-ending-shed"
      TAG: shed

- name: thanos-vizzini-grootfs-custom-agent
  serial_groups: [vizzini]
  plan:
  - aggregate:
    - get: vizzini-time-trigger
      tags: [thanos]
      trigger: true
    - get: diego-release-git
    - get: grootfs-release-develop
      tags: [thanos]
      trigger: true
      params:
        submodules: none
  - task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-starting-grootfs-custom-agent"
      TAG: custom-agent
  - task: run-vizzini-grootfs-custom-agent
    tags: [thanos]
    privileged: true
    file: grootfs-release-develop/ci/tasks/vizzini-ginkgo.yml
    params:
      BOSH_TARGET: {{thanos-bosh-target}}
      BOSH_CLIENT: {{thanos-bosh-username}}
      BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
      BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
      DIEGO_CREDENTIALS: {{thanos-cf-diego-certs}}
      ENV: thanos
      PLACEMENT_TAG: custom_agent
    on_failure:
      task: publish-datadog-event
      file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
      params:
        DATADOG_API_KEY: {{datadog-api-key}}
        EVENT_NAME: vizzini-failed-grootfs-custom-agent
        TAG: custom-agent
  ensure:
    task: publish-datadog-event
    file: grootfs-release-develop/ci/tasks/publish-datadog-event.yml
    params:
      DATADOG_API_KEY: {{datadog-api-key}}
      EVENT_NAME: "vizzini-ending-grootfs-custom-agent"
      TAG: custom-agent

- name: bench-without-loops
  serial_groups:
  - deploy-thanos-cf
  public: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
        tags: [thanos]
        trigger: true
        passed: [deploy-thanos-cf]
        params:
          submodules: none
      - get: grootfs-bench-release
        tags: [thanos]
      - get: thanos-bench-time-trigger
        trigger: true
        tags: [thanos]
    - task: benchmark-LOCAL-LOOPLESS
      tags: [thanos]
      privileged: true
      file: grootfs-bench-release/ci/tasks/performance-tests.yml
      params:
        BOSH_TARGET: {{thanos-bosh-target}}
        BOSH_CLIENT: {{thanos-bosh-username}}
        BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
        BOSH_DEPLOYMENT: cf
        BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
        ERRAND_NAME: loopless-bench-errand
        DATADOG_API_KEY: {{datadog-api-key}}
        DATADOG_APPLICATION_KEY: {{datadog-application-key}}

- name: bench-with-loops
  serial_groups:
  - deploy-thanos-cf
  public: true
  plan:
  - do:
    - aggregate:
      - get: grootfs-release-develop
        tags: [thanos]
        trigger: true
        passed: [deploy-thanos-cf]
        params:
          submodules: none
      - get: grootfs-bench-release
        tags: [thanos]
      - get: thanos-bench-time-trigger
        trigger: true
        tags: [thanos]
    - task: benchmark-LOCAL-LOOPED
      tags: [thanos]
      privileged: true
      file: grootfs-bench-release/ci/tasks/performance-tests.yml
      params:
        BOSH_TARGET: {{thanos-bosh-target}}
        BOSH_CLIENT: {{thanos-bosh-username}}
        BOSH_CLIENT_SECRET: {{thanos-bosh-password}}
        BOSH_DEPLOYMENT: cf
        BOSH_CERTIFICATES: {{thanos-bosh-certificates}}
        ERRAND_NAME: looped-bench-errand
        DATADOG_API_KEY: {{datadog-api-key}}
        DATADOG_APPLICATION_KEY: {{datadog-application-key}}

- name: deliver
  plan:
  - get: grootfs-bench-release
    trigger: true
    passed:
    - btrfs-performance-tests
    - xfs-performance-tests
  - get: grootfs-release-develop
    trigger: true
    passed:
    - CATs
    - GATs
    - btrfs-performance-tests
    - xfs-performance-tests
    - test-upgrade
  - put: grootfs-tracker
    params:
      repos:
      - grootfs-release-develop/src/code.cloudfoundry.org/grootfs
      - grootfs-release-develop
      - grootfs-bench-release/src/code.cloudfoundry.org/grootfs-bench
      - grootfs-bench-release

- name: test-grootfs-diagnostics-release
  plan:
  - aggregate:
    - get: grootfs-diagnostics-develop
      trigger: true
  - do:
    - task: test
      file: grootfs-diagnostics-develop/ci/tasks/test.yml
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: "https://i.imgur.com/0xoYLaO.png?1"
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: BOO! Not cool: http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

- name: create-grootfs-diagnostics-release
  plan:
  - aggregate:
    - get: grootfs-release-develop
    - get: version
      resource: grootfs-diagnostics-release-version
      params:
        pre: rc
    - get: release
      resource: grootfs-diagnostics-develop
      passed: [test-grootfs-diagnostics-release]
      params:
        submodules: none
  - put: grootfs-diagnostics-release-version
    params:
      file: version/number
  - do:
    - task: create-grootfs-diagnostics-release
      file: grootfs-release-develop/ci/tasks/create-bosh-release.yml
      params:
        NAME: grootfs-diagnostics
    - put: grootfs-diagnostics-release-tarball
      params:
        file: bosh-release/grootfs-diagnostics-*.tgz
    on_failure:
      put: slack-alert
      params:
        username: {{slack-alert-username}}
        icon_url: "https://i.imgur.com/0xoYLaO.png?1"
        channel: {{slack-alert-channel}}
        text: "<!subteam^S1U0HSJ9E|grootfsteam>: BOO! Not cool: http://grootfs.ci.cf-app.com/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"

resource_types:
- name: slack-notification-docker
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
- name: tracker-fixed
  type: docker-image
  source:
    repository: concourse/tracker-resource
- name: datadog-event
  type: docker-image
  source:
    repository: concourse/datadog-event-resource
- name: bosh-deployment-resource
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource
